<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Tagihan Harian</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-blue-600 mb-8">Pencatatan Tagihan Harian</h1>

        <!-- Form untuk menambahkan item -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold mb-4">Tambah Item Tagihan</h2>
            <form id="item-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="col-span-1 md:col-span-1">
                    <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <input type="text" id="item-name" placeholder="Mis. Nasi Goreng" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="col-span-1">
                    <label for="item-qty" class="block text-sm font-medium text-gray-700 mb-1">Jumlah</label>
                    <input type="number" id="item-qty" value="1" min="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="col-span-1">
                    <label for="item-price" class="block text-sm font-medium text-gray-700 mb-1">Harga Satuan</label>
                    <input type="number" id="item-price" placeholder="Mis. 15000" min="0" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="col-span-1">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        Tambah
                    </button>
                </div>
            </form>
            <!-- Area untuk menampilkan pesan error -->
            <p id="error-message" class="text-red-500 text-sm mt-2"></p>
        </div>

        <!-- Bagian Alamat, Kamera, dan Peta -->
        <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold mb-4">Informasi Lokasi & Bukti Foto</h2>
            <div class="flex flex-col md:flex-row gap-4 items-end mb-4">
                <div class="flex-grow">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Alamat Tagihan</label>
                    <input type="text" id="address" placeholder="Masukkan alamat atau dapatkan lokasi otomatis" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <button id="get-location-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200">
                        Dapatkan Lokasi
                    </button>
                </div>
            </div>
            <div id="map-container" class="mt-4 hidden">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Lokasi di Peta:</h3>
            </div>
            <p id="location-status" class="text-sm mt-2 text-gray-500"></p>

            <div class="mt-4">
                <label for="item-image" class="block text-sm font-medium text-gray-700 mb-1">Ambil Foto Bukti</label>
                <input type="file" id="item-image" accept="image/*" capture="camera" class="w-full px-3 py-2 border rounded-lg bg-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <div id="image-preview-container" class="mt-4 hidden">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Pratinjau Foto:</h3>
                    <img id="image-preview" class="w-full h-auto rounded-lg shadow-md max-h-64 object-contain">
                </div>
            </div>
        </div>

        <!-- Daftar item tagihan -->
        <div id="billing-summary" class="overflow-x-auto">
            <!-- Transaksi dan tabel item akan dirender di sini oleh JavaScript -->
        </div>

        <!-- Total dan tombol bersihkan -->
        <div class="flex flex-col md:flex-row justify-between items-center mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
            <div class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">
                Total Seluruh Transaksi: <span id="grand-total" class="text-blue-600 ml-2">Rp 0</span>
            </div>
            <button id="clear-button" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition-colors duration-200">
                Bersihkan Semua Tagihan
            </button>
        </div>
    </div>

    <script>
        // Array untuk menyimpan semua transaksi tagihan
        let transactions = [];
        let currentImageBase64 = null; // Variabel untuk menyimpan gambar sementara

        // Mendapatkan elemen HTML
        const itemForm = document.getElementById('item-form');
        const itemNameInput = document.getElementById('item-name');
        const itemQtyInput = document.getElementById('item-qty');
        const itemPriceInput = document.getElementById('item-price');
        const billingSummaryDiv = document.getElementById('billing-summary');
        const grandTotalSpan = document.getElementById('grand-total');
        const clearButton = document.getElementById('clear-button');
        const errorMessage = document.getElementById('error-message');
        
        // Elemen untuk fitur lokasi dan kamera
        const getLocationBtn = document.getElementById('get-location-btn');
        const addressInput = document.getElementById('address');
        const mapContainer = document.getElementById('map-container');
        const locationStatus = document.getElementById('location-status');
        const itemImageInput = document.getElementById('item-image');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');

        // Fungsi untuk memformat mata uang Rupiah
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        // Fungsi untuk menyimpan seluruh array transaksi ke Local Storage
        const saveTransactions = () => {
            localStorage.setItem('daily-billing-app-transactions', JSON.stringify(transactions));
        };

        // Fungsi untuk memuat seluruh array transaksi dari Local Storage
        const loadTransactions = () => {
            const savedTransactions = localStorage.getItem('daily-billing-app-transactions');
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
        };

        // Fungsi untuk merender daftar transaksi
        const renderList = () => {
            billingSummaryDiv.innerHTML = '';
            let grandTotal = 0;

            if (transactions.length > 0) {
                transactions.forEach((transaction, index) => {
                    let transactionTotal = 0;
                    
                    // Tampilkan alamat dan gambar untuk setiap transaksi
                    const transactionBlock = document.createElement('div');
                    transactionBlock.className = 'bg-gray-100 p-4 rounded-lg mb-2 mt-4';
                    
                    let imageHtml = '';
                    if (transaction.image) {
                        imageHtml = `<img src="${transaction.image}" class="w-full h-auto rounded-lg shadow-md mt-2 max-h-64 object-contain" alt="Bukti Foto Transaksi">`;
                    }
                    
                    transactionBlock.innerHTML = `
                        <h3 class="text-md font-semibold text-gray-700">Transaksi #${index + 1}</h3>
                        <p class="text-sm text-gray-600">Alamat: ${transaction.address}</p>
                        ${imageHtml}
                    `;
                    billingSummaryDiv.appendChild(transactionBlock);

                    // Buat tabel untuk item dalam transaksi ini
                    const table = document.createElement('table');
                    table.className = 'min-w-full bg-white rounded-lg shadow-md mb-4';
                    table.innerHTML = `
                        <thead>
                            <tr class="bg-gray-200 text-left text-sm font-semibold text-gray-700">
                                <th class="px-4 py-2 rounded-tl-lg">Nama Barang</th>
                                <th class="px-4 py-2">Jumlah</th>
                                <th class="px-4 py-2">Harga Satuan</th>
                                <th class="px-4 py-2 rounded-tr-lg">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    billingSummaryDiv.appendChild(table);
                    const itemListBody = table.querySelector('tbody');

                    transaction.items.forEach(item => {
                        const subtotal = item.qty * item.price;
                        transactionTotal += subtotal;
                        grandTotal += subtotal;

                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 last:border-b-0';
                        row.innerHTML = `
                            <td class="px-4 py-2">${item.name}</td>
                            <td class="px-4 py-2">${item.qty}</td>
                            <td class="px-4 py-2">${formatRupiah(item.price)}</td>
                            <td class="px-4 py-2 font-semibold">${formatRupiah(subtotal)}</td>
                        `;
                        itemListBody.appendChild(row);
                    });
                });
            } else {
                const emptyListMessage = document.createElement('p');
                emptyListMessage.id = 'empty-list-message';
                emptyListMessage.className = 'text-center text-gray-500 italic mt-4';
                emptyListMessage.textContent = 'Tidak ada item tagihan.';
                billingSummaryDiv.appendChild(emptyListMessage);
            }
            
            // Perbarui total keseluruhan
            grandTotalSpan.textContent = formatRupiah(grandTotal);
        };

        // Event listener untuk input kamera
        itemImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentImageBase64 = event.target.result;
                    imagePreview.src = currentImageBase64;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                currentImageBase64 = null;
                imagePreview.src = '';
                imagePreviewContainer.classList.add('hidden');
            }
        });

        // Event listener untuk form
        itemForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Mencegah form untuk reload halaman

            const name = itemNameInput.value.trim();
            const qty = parseInt(itemQtyInput.value);
            const price = parseFloat(itemPriceInput.value);
            const address = addressInput.value.trim();

            // Validasi input
            if (name === '' || isNaN(qty) || isNaN(price) || qty <= 0 || price < 0) {
                errorMessage.textContent = 'Semua bidang harus diisi dengan benar!';
                return;
            }

            // Buat objek transaksi baru
            const newTransaction = {
                address: address,
                image: currentImageBase64, // Tambahkan gambar ke transaksi
                items: [{ name, qty, price }]
            };
            transactions.push(newTransaction);

            // Bersihkan input field, kecuali alamat
            itemNameInput.value = '';
            itemQtyInput.value = '1';
            itemPriceInput.value = '';
            errorMessage.textContent = ''; // Hapus pesan error
            
            // Bersihkan input gambar dan pratinjau
            itemImageInput.value = null;
            currentImageBase64 = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');

            renderList(); // Perbarui tampilan daftar
            saveTransactions(); // Simpan perubahan ke Local Storage
        });

        // Event listener untuk tombol bersihkan
        clearButton.addEventListener('click', () => {
            transactions = []; // Kosongkan array transaksi
            renderList(); // Perbarui tampilan
            // Hapus data dari Local Storage
            localStorage.removeItem('daily-billing-app-transactions');
            addressInput.value = '';
            mapContainer.innerHTML = '';
            mapContainer.classList.add('hidden');
            locationStatus.textContent = '';
            itemImageInput.value = null;
            currentImageBase64 = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
        });

        // Event listener untuk tombol 'Dapatkan Lokasi'
        getLocationBtn.addEventListener('click', () => {
            locationStatus.textContent = 'Mencari lokasi...';
            mapContainer.innerHTML = '';
            mapContainer.classList.add('hidden');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        locationStatus.textContent = `Lokasi ditemukan: Latitude ${lat}, Longitude ${lon}`;
                        addressInput.value = `Lokasi saat ini: Latitude ${lat}, Longitude ${lon}`;
                        
                        // Buat placeholder peta statis
                        const mapImage = document.createElement('img');
                        mapImage.src = `https://placehold.co/600x300/a0aec0/ffffff?text=Lokasi+Anda&font=inter`; // URL placeholder
                        mapImage.alt = 'Peta lokasi saat ini';
                        mapImage.className = 'w-full h-auto rounded-lg shadow-md mt-2';
                        mapContainer.innerHTML = ''; // Pastikan bersih
                        mapContainer.appendChild(mapImage);
                        mapContainer.classList.remove('hidden');
                    },
                    (error) => {
                        let errorMessageText = '';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessageText = 'Anda menolak permintaan lokasi.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessageText = 'Informasi lokasi tidak tersedia.';
                                break;
                            case error.TIMEOUT:
                                errorMessageText = 'Permintaan untuk mendapatkan lokasi Anda habis waktu.';
                                break;
                            default:
                                errorMessageText = 'Terjadi kesalahan yang tidak diketahui.';
                                break;
                        }
                        locationStatus.textContent = `Gagal mendapatkan lokasi: ${errorMessageText}`;
                        console.error('Geolocation Error:', { code: error.code, message: error.message });
                    }
                );
            } else {
                locationStatus.textContent = 'Browser Anda tidak mendukung Geolocation API.';
            }
        });

        // Panggil loadTransactions dan renderList saat halaman pertama kali dimuat
        loadTransactions();
        renderList();
    </script>

</body>
</html>
